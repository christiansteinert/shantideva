<!doctype html>
<html class="no-js">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width" />
    <link rel="stylesheet" type="text/css" href="css/custom.css" />
    <link rel="stylesheet" type="text/css" href="lib/jquery-ui-1.12.1.custom/jquery-ui.min.css" />

    <link rel="icon" href="favicon_180.png" type="image/png" sizes="180x180" />
    <link rel="icon" href="favicon_48.png" type="image/png" sizes="48x48" />    
    <link rel="icon" href="favicon_32.png" type="image/png" sizes="32x32" />    
    <link rel="icon" href="favicon_24.png" type="image/png" sizes="24x24" />    
    <link rel="icon" href="favicon_16.png" type="image/png" sizes="16x16" />    
    <link rel="apple-touch-icon" href="apple_icon180.png" type="image/png" sizes="180x180" />    
    
	<script src="lib/jquery-3.1.1.min.js" charset="UTF-8"></script> 
	<script src="lib/jquery-ui-1.12.1.custom/jquery-ui.min.js" charset="UTF-8"></script> 
	
	<script src="content/localize.js" charset="UTF-8"></script>
	
	<title>Shantideva</title>

<script>

CONFIG = {
  _language:null,
  _textLanguage:null,
  _textLanguage2:null,
  _textLanguage3:null,
  _messageEnabled:null,
  _messageHour:null,
  _colorTheme:null,
  _fontSize:null,
    
  isInitialized:function() {
    if(this._language) {
      return true;
    } else {
      return false;
    }
  },
  
  isSettingsMigrationNeeded:function() {
    var cfgSetting = localStorage.getItem("uiLanguage");
    if(!cfgSetting) {
      // ui language is not set. Configuration must be adjusted
      return true;
    } else {
      // ui language is set. Configuration has the latest format and need not be migrated
      return false;
    }
  },
  
  /** get UI language */
  getUILang:function() {
    if(this._language === null) {
      // get ui language from configuration
      var cfgSetting = localStorage.getItem("uiLanguage");
      if(cfgSetting) {
        this._language = cfgSetting;
      } 
    
      // check if any of the user's preferred language is supported by the app
      if(!this._language) {
        if(navigator.languages) {
            for(var i in navigator.languages) {
                var locale = navigator.languages[i].toLowerCase(); // full locale, e.g. zh-CN
                var lang   = locale.substring(0,2); // language, e.g. zh or en
                
                if(lang == 'zh') {
                  if(locale.indexOf('hans')) {
                    lang = "zh-cn"; // simplified chinese, specified explicitly
                  } if(locale.indexOf('hant')||locale.indexOf('tw')||locale.indexOf('hk')||locale.indexOf('mo')) {
                    lang = "zh-tw"; // traditional chinese
                  } else {
                    lang = "zh-cn"; // simplified chinese
                  }
                }
                
                if(LANG_LIST[lang]) {
                    this._language = lang;
                    break;
                }
            }
        }
      }

      if(!this._language) {
        if (navigator.language && LANG_LIST[navigator.language]) {
            this._language = navigator.language;
        }
      }

      if(!this._language)
        this._language = 'en';
    }
    return this._language;
  },
  
  getMessageEnabled:function() {
    if(this._messageEnabled === null) {
      var cfgSetting = localStorage.getItem("messageEnabled");
      if(cfgSetting === false || cfgSetting === "false"  ) {
        this._messageEnabled = false; // user has deactivated notifications  
      } else {
        this._messageEnabled = true;  // user not deactivated notifications (default behavior or explicit activation)
      }
    }
    return this._messageEnabled;
  },

  getMessageHour:function() {
    if(this._messageHour === null) {
      var cfgSetting = localStorage.getItem("messageHour");
      if(cfgSetting || (cfgSetting == 0)) {
        this._messageHour = Number( cfgSetting ); // configured notification hour
      } else {
        this._messageHour = 10; // default notification hour
      }
    }
    return this._messageHour;
  },

  getFontSize:function() {
    if(this._fontSize === null) {
      var cfgSetting = localStorage.getItem("fontSize");
      
      if(cfgSetting && parseInt(cfgSetting) >= 50) {
        this._fontSize = parseInt(cfgSetting); // configured font size
      } else {
        this._fontSize = 100; // default font size
      }
    }
    return this._fontSize;
  },

  getColorTheme:function() {
    if(this._colorTheme === null) {
      var cfgSetting = localStorage.getItem("colorTheme");
      if(cfgSetting) {
        // the user has saved a setting for the color theme. Use it
        this._colorTheme = cfgSetting;
      } else { // color theme has not been configured yet. Return default setting
        this._colorTheme = 'light'; // standard behavior is light theme.
        if((window.matchMedia)) {        
          var prefersDarkScheme = window.matchMedia('(prefers-color-scheme:dark)');
          if(prefersDarkScheme.matches) {
            this._colorTheme = 'dark'; // The browser says that the user prefers a dark theme. Use it.
          }
        }
      }
    }
    return this._colorTheme;
  },  

  /** get current text language */
  getTextLang:function( ) {
    if(this._textLanguage === null) {
      var cfgSetting = localStorage.getItem("textLanguage");
      if(cfgSetting) {
        this._textLanguage = cfgSetting;
      } else {
        var uiLang = this.getUILang();
        if(TEXT_LANG_LIST[uiLang]) {
          this._textLanguage = uiLang;
        } else {
          this._textLanguage = 'en';
        }
      }
    }
    return this._textLanguage;
  },

  getTextLang2:function( ) {
    if(this._textLanguage2 === null) {
      var cfgSetting = localStorage.getItem("textLanguage2");
      if(cfgSetting) {
        this._textLanguage2 = cfgSetting;
      } else {
        this._textLanguage2 = ''; // default value is that 2nd text language is deactivated
      }
    }
    return this._textLanguage2;
  },

  getTextLang3:function( ) {
    if(this._textLanguage3 === null) {
      var cfgSetting = localStorage.getItem("textLanguage3");
      if(cfgSetting) {
        this._textLanguage3 = cfgSetting;
      } else {
        this._textLanguage3 = ''; // default value is that 3rd text language is deactivated
      }
    }
    return this._textLanguage3;
  },
  
  
  getCssClassForLang:function(lang) {    
    if ( lang == 'bo' || lang == 'ru' || lang == 'ar' || lang == 'zh-cn' || lang == 'zh-tw')
      return lang;
    else if (lang == 'sa-devanagari') 
      return lang;
    else 
      return 'latin ' + this.getLangCode( lang );
  },

  getLangCode:function(lang) {
    // cut off anything behind dash from the language code
    return lang.replace(/-.*/,'');
  },
  
  getTextUrl:function() {
    return 'content/text_'+this.getTextLang()+'.txt';
  },
  
  getTextUrl2:function() {
    return 'content/text_'+this.getTextLang2()+'.txt';
  },    
  
  getTextUrl3:function() {
    return 'content/text_'+this.getTextLang3()+'.txt';
  },
  
  getSettingsFromConfig:function() {
    var uiLang = this.getUILang();
    var verseOfTheDayTxt = UI.getText("Verse of the Day");
    
    var settings = {
      uiLanguage: uiLang,
      fontSize: this.getFontSize(),
      colorThemeSize: this.getColorTheme(),
      textLanguage: this.getTextLang(),
      textLanguage2: this.getTextLang2(),
      textLanguage3: this.getTextLang3(),
      messageEnabled: this.getMessageEnabled(),
      messageHour: this.getMessageHour(),
      messageMinute: 0,
      verseOfTheDay: verseOfTheDayTxt
    };
    
    return settings;
  },
  
  /**
   * mix settings from the cordova side with settings from the Javascript UI layer
   */
  mixSettings:function(cordovaSettings, jsSettings) {
    var settings = jsSettings;
      
    if(Object.keys(cordovaSettings).length > 0) {
      // settings from cordova - especially locale settings - are more reliable. Prefer them if they are present
      if(cordovaSettings.uiLanguage) {
        settings.uiLanguage = cordovaSettings.uiLanguage;
        
        // localized texts come only from UI layer. So always get the text "Verse of the Day" from Javascript
        settings.verseOfTheDay = UI.getText("Verse of the Day", settings.uiLanguage);
      }

      if(cordovaSettings.textLanguage) {
        settings.textLanguage = cordovaSettings.textLanguage;    
        settings.textLanguage2 = cordovaSettings.textLanguage2;    
        settings.textLanguage3 = cordovaSettings.textLanguage3;    
      }
      
      if ('messageHour' in cordovaSettings) {
        settings.messageHour = cordovaSettings.messageHour;
        settings.messageMinute = cordovaSettings.messageMinute;
        settings.messageEnabled = cordovaSettings.messageEnabled;
      }
      
      this.saveSettings(settings);
    }
  },
  
  /* load all settings */
  loadSettings:function(callbackFunc) {
    // Load settings from the cordova plugin if there are any.
    // Then mix this with additional default settings. 
    // If necessary then we will save the settings back again so that the 
    // Java code has a new clean state
    if(this.isSettingsMigrationNeeded()) {
      this.getCordovaPlugin().loadSettings(
        function(cordovaSettings) {
          CONFIG.mixSettings(cordovaSettings, CONFIG.getSettingsFromConfig());
          callbackFunc();
        }
      );
    } else {
      //we already have the settings that we need
      //no need to do a config migration or wait for Cordova to start up.
      //we can run directly with the settings that are stored on the Javascript side
      callbackFunc();
    }
  },
  
  /* save all settings  
   * attributes of the settings object: {messageEnabled:true, messageHour:'10', messageMinute:00, uiLanguage:'en', textLanguage:'en', textLanguage2:''}
   */ 
  saveSettings:function(settings) {
    for(var setting in settings) {
      // save all configuration properties
      localStorage.setItem(setting, settings[setting] );
    }
    
    this.getCordovaPlugin().saveSettings(settings);
    
    // update locally cached settings in this class as well
    this._language = settings.uiLanguage;
    this._textLanguage = settings.textLanguage;
    this._textLanguage2 = settings.textLanguage2;
    this._textLanguage3 = settings.textLanguage3;
    this._messageEnabled = settings.messageEnabled;
    this._messageHour = settings.messageHour;
  },
  
  /* get the object of our native cordova plugin */
  getCordovaPlugin:function(settings) {
    if(window.cordova && cordova.plugins && cordova.plugins.DailyVersesPlugin) {
      // we are running inside of cordova - return the native plugin
      return cordova.plugins.DailyVersesPlugin;
    } else {
      // we are running as web application. Return a dummy object
      return {
        testNotification: function(success, error) {},
        setAlarm: function(success, error) {},
        testTimer: function(success, error) {},
        saveSettings:function(settings, success, error) {},
        loadSettings:function(success, error) {success({}); }
      }
    }
  }
}


UI = {
  currentChapter: -1,
  _isSettingsInitialized:false,
  _lastPauseTime:null,
  _activeTab:null,

  _setDropdownValues:function(dropdownId, options, selectedOption ) {
      var optHtml='';
      for(var opt in options) {
        optHtml += '<option value="'+ opt +'">'+ options[opt] +'</option>'
      }
      var $dropdown = $('#'+dropdownId);
      $dropdown.html( $dropdown.html() + optHtml );      
      $dropdown.val(selectedOption);
  }, 

  getSettingsFromUI:function() {
    var uiLang = $('#uiLanguage').val();
    if(!LANG_LIST[uiLang]) {
      uiLang = 'en';
    }
    var verseOfTheDayTxt = UI.getText("Verse of the Day");
    var settings = {
      uiLanguage: uiLang,
      fontSize: $('#fontSize').val(),
      colorTheme: $('#colorTheme').val(),
      textLanguage: $('#textLanguage').val(),
      textLanguage2: $('#textLanguage2').val(),
      textLanguage3: $('#textLanguage3').val(),
      messageEnabled: $('#messageEnabled').is(":checked"),
      messageHour: parseInt($('#messageHour').val(),10),
      messageMinute: 0,
      verseOfTheDay: verseOfTheDayTxt
    };
    
    if(!settings.textLanguage2) {
      settings.textLanguage2 = '';
    }
    return settings;
  },
  
  onPause:function() {
    this._lastPauseTime = new Date();
  },

  onResume:function() {
    if(this._activeTab == 'homeTab') {
      // Refresh the content of the home tab when the app was in background to make sure 
      // that the home tab definitely shows the current verse of the day even after a date rollover.
      // If a tab other than the home tab is active at the moment then we don't need to do anything 
      // because the content of that tab will be refreshed if the user clicks on it.
      this.openTab('homeTab');
      
    } else if(this._lastPauseTime) {
      // if the app was in the background for more than 1 hour
      // then reload to refresh the view and show the initial view again
      var now = new Date();
      var elapsedTimeMillis = now.getTime() - this._lastPauseTime.getTime();
      
      if (elapsedTimeMillis > 3600000 ) { 
        location.reload();
      }
    }
    
    this._lastPauseTime = null;
  },
  
  
  btnSave:function() {
    var settings = this.getSettingsFromUI();
    CONFIG.saveSettings( settings );
    location.reload();
  },

  btnCancel:function() {
    location.reload();
  },

  initSettingsTab:function() {
    if(!this._isSettingsInitialized) {
      if(!window.cordova) {
        $("#settingsTab").addClass("web");
      } else {
        $("#settingsTab").addClass("mobile");      
      }
      $("#settingsTab").addClass( CONFIG.getCssClassForLang(CONFIG.getUILang()) );
    
      $("#messageEnabled").prop("checked", CONFIG.getMessageEnabled() );
      $("#messageHour").val(CONFIG.getMessageHour() );
      $("#fontSize").val(CONFIG.getFontSize());
      $("#colorTheme").val(CONFIG.getColorTheme());

      $("#settingsTab input[type=checkbox]").checkboxradio();
      //$("#settingsTab select").selectmenu();
      $("#settingsTab button").button();
      
      /* language dropdowns for text language */
      this._setDropdownValues('textLanguage', TEXT_LANG_LIST, CONFIG.getTextLang());      
      this._setDropdownValues('textLanguage2', TEXT_LANG_LIST, CONFIG.getTextLang2());
      this._setDropdownValues('textLanguage3', TEXT_LANG_LIST, CONFIG.getTextLang3());
      
      /* language dropdowns for text language */
      this._setDropdownValues('uiLanguage', LANG_LIST, CONFIG.getUILang());      

      $("#saveBtn").click(function( event ) { UI.btnSave(); }); 
      $("#cancelBtn").click(function( event ) { UI.btnCancel(); }); 
      
      this._isSettingsInitialized = true;
    }
  },
  
  openTab:function(tabName) {
    if(tabName == 'homeTab') {
      this.updateVerseOfTheDay();
    } else if(tabName == 'textTab') {
      if(this.currentChapter == -1) {
        this.showChapter(1);
      }
    } else if(tabName == 'settingsTab') {
      this.initSettingsTab();
    }
    
    this.doOpenTab(tabName);
    this.scrollElementToTop($('#'+tabName)[0]);
  },
  
  doOpenTab:function(tabName) {
    $('.tabcontent').hide(); // hide all tab content
    $('#'+tabName).show(); // show desired tab content
    
    $('.tabtitle').hide(); // hide all tabs titles
    $('#'+tabName+"Title").show(); // show title of desired tab
    $('#footer .tab').show(); // make sure the footer becomes visible
    
    $('.tab li').removeClass("active"); // make the currently active tab inactive
    $('#'+tabName+"Link").parent().addClass("active"); // make the newly selected tab active

    this._activeTab = tabName;  
  },

  replaceAll:function(str, search, replace) {
    return str.split(search).join(replace);
  },
  
  /** Localize a text */
  getText:function(txtid, lng) {
    var lang = lng || CONFIG.getUILang();
    var txt = "";
    if (window.LANG && LANG[lang]) {
      txt = LANG[lang][txtid];
    } 
    if(!txt) {
      txt = txtid;
    }
    
    if(arguments.length > 2) { // additional placeholders present
      for(var i=1;i<arguments.length;i++) {
        txt = txt.replace('%'+i,arguments[i+1]);
      }
    }

    return txt;
  },

  localizeText:function() {
    var htmlCode = $('body').html();
    if (window.LANG && LANG[CONFIG.getUILang()]) {
      for(var txtid in LANG[CONFIG.getUILang()]) {
        var textVal = LANG[CONFIG.getUILang()][txtid];
        htmlCode = this.replaceAll(htmlCode,"{{"+txtid+"}}",textVal);
      }
    }
    htmlCode = this.replaceAll(htmlCode,"{{","");
    htmlCode = this.replaceAll(htmlCode,"}}","");
    $('body').html(htmlCode);
    
    var lang = CONFIG.getLangCode( CONFIG.getUILang() );    
    $('body').attr('lang',lang);

    $('.header,.footer').addClass( CONFIG.getCssClassForLang(CONFIG.getUILang()) );
  },
  
  scrollElementIntoView:function(scrollParent, targetElement, deltaOffset) {  
    if(!deltaOffset) {
      deltaOffset=0;
    }
    scrollParent.parentNode.scrollTop = targetElement.offsetTop + deltaOffset;
    $(targetElement).effect("highlight", {}, 1500);
  },
  
  scrollElementToTop:function(scrollParent) {  
    scrollParent.parentNode.scrollTop = 0;
  },
  
  jumpToVerseOfTheDay:function() {
    var verseInfo = DATA.getVerseOfTheDay(1);
    this.showChapter(verseInfo.chapter);
    this.openTab('textTab');
    
    var verseId = '#verse'+verseInfo.totalNr;
    var verseDom = $(verseId);
    this.scrollElementIntoView($('#textTab')[0], verseDom[0], -8);
  },
  
  updateVerseOfTheDay:function() {
    var verseInfo = DATA.getVerseOfTheDay(1);
    var verseInfo2 = DATA.getVerseOfTheDay(2);
    var verseInfo3 = DATA.getVerseOfTheDay(3);
    var verseText = DATA.getVerseText( verseInfo );
    var verseText2 = DATA.getVerseText( verseInfo2 );
    var verseText3 = DATA.getVerseText( verseInfo3 );
    var langCode1 = CONFIG.getTextLang();
    var langCode2 = CONFIG.getTextLang2();
    var langCode3 = CONFIG.getTextLang3();
    var cssClass = CONFIG.getCssClassForLang(langCode1);
    var cssClass2 = CONFIG.getCssClassForLang(langCode2);
    var cssClass3 = CONFIG.getCssClassForLang(langCode3);
    var lang = CONFIG.getLangCode(langCode1);
    var lang2 = CONFIG.getLangCode(langCode2);
    var lang3 = CONFIG.getLangCode(langCode3);

    
    htmlCode = '<div id="verseOfTheDayCont" class="vcenterContainer"><div id="verseOfTheDay" class="vcenter">';
    htmlCode += '<div id="verseOfTheDayNarrow">';

    htmlCode += '<div class="verse '+cssClass+'" lang="'+lang+'">'
    htmlCode += verseText;
    htmlCode += '</div>'

    htmlCode += '<p><a href="javascript:void(0)" onclick="UI.jumpToVerseOfTheDay()" title="'+this.getText('Jump to this verse in the text.')+'">'+this.getText('Chapter %1, Verse %2', CONFIG.getUILang(), verseInfo.chapter, verseInfo.nr)+'</a></p>';

    if(verseText2) {
      htmlCode += '<div class="verse '+cssClass2+'" lang="'+lang2+'">'
      htmlCode += verseText2;
      htmlCode += '</div>'
      htmlCode += '<p><a href="javascript:void(0)" onclick="UI.jumpToVerseOfTheDay()" title="'+this.getText('Jump to this verse in the text.')+'">'+this.getText('Chapter %1, Verse %2', CONFIG.getUILang(), verseInfo.chapter, verseInfo.nr)+'</a></p>';
    }

    if(verseText3) {
      htmlCode += '<div class="verse '+cssClass3+'" lang="'+lang3+'">'
      htmlCode += verseText3;
      htmlCode += '</div>'
      htmlCode += '<p><a href="javascript:void(0)" onclick="UI.jumpToVerseOfTheDay()" title="'+this.getText('Jump to this verse in the text.')+'">'+this.getText('Chapter %1, Verse %2', CONFIG.getUILang(), verseInfo.chapter, verseInfo.nr)+'</a></p>';
    }
    
    htmlCode += '</div></div></div>';
    $('#homeTab').html(htmlCode);
    
    $('#homeTab a').button();
  },

  showChapter:function(chapterNr) {
    if(this.currentChapter != chapterNr) {
        var langCode1 = CONFIG.getTextLang();
        var cssClass = CONFIG.getCssClassForLang(langCode1);
        var langCode2 = CONFIG.getTextLang2();
        var cssClass2 = CONFIG.getCssClassForLang(langCode2);
        var langCode3 = CONFIG.getTextLang3();
        var cssClass3 = CONFIG.getCssClassForLang(langCode3);
        var lang = CONFIG.getLangCode(langCode1);
        var lang2 = CONFIG.getLangCode(langCode2);
        var lang3 = CONFIG.getLangCode(langCode3);
    
        if(chapterNr < 1) {
          chapterNr = 1;
        } else if(chapterNr >= DATA.chaptersSizes.length - 1) {
          chapterNr = DATA.chaptersSizes.length - 1;
        }
        $('#textTabTitle').attr('lang',CONFIG.getLangCode(lang));
        $('#textTabTitle').addClass(CONFIG.getCssClassForLang(lang));
        
        // select the right chapter in the dropdown
        $('#chapterDropdown select').val(chapterNr).selectmenu("refresh");
        
        // show the chapter content on the "full text" tab
        var htmlCode = '<div class="textView"><div><h1 class="'+cssClass+'" lang="'+lang+'">'+DATA.chaptersNames[chapterNr] + '</h1></div>';
        if(lang2 && DATA.chaptersNames2[chapterNr]) {
          htmlCode += '<div><h1 class="'+cssClass2+'" lang="'+lang2+'">'+DATA.chaptersNames2[chapterNr]+ '</h1></div>';
        }
        if(lang3 && DATA.chaptersNames3[chapterNr]) {
          htmlCode += '<div><h1 class="'+cssClass3+'" lang="'+lang3+'">'+DATA.chaptersNames3[chapterNr]+ '</h1></div>';
        }
        
        for(var i=0;i<DATA.verses.length;i++) {
          var verse=DATA.verses[i];
          if(verse.chapter == chapterNr) {
            htmlCode+='<div class="verse '+cssClass+'" lang="'+lang+'" id="verse'+verse.totalNr+'">' + verse.verseText + '</div>';
            if(lang2 && DATA.verses2.length > i) {
              var verse2=DATA.verses2[i];
              htmlCode+='<div class="verse '+cssClass2+'" lang="'+lang2+'" id="verse'+verse.totalNr+'b">' + verse2.verseText + '</div>';
            }
            if(lang3 && DATA.verses3.length > i) {
              var verse3=DATA.verses3[i];
              htmlCode+='<div class="verse '+cssClass3+'" lang="'+lang3+'" id="verse'+verse.totalNr+'c">' + verse3.verseText + '</div>';
            }
          }
        }
        
        htmlCode+='</div>';
        var $textTab = $('#textTab');
        $textTab.html(htmlCode);
        this.scrollElementToTop($textTab[0]);
        
        this.currentChapter = chapterNr;
    }
  },
  
  moveChapter:function(direction) {
    var newChapter = this.currentChapter + direction;
    this.showChapter(newChapter);
  },
  
  initChaptersDropdown:function() {
    var htmlCode = '<select>'
    for(var chapter in DATA.chaptersNames) {
      htmlCode += '<option value="'+chapter+'">'+DATA.chaptersNames[chapter]+'</option>'
    }
    htmlCode += '</select>'

    var cssClass = CONFIG.getCssClassForLang(CONFIG.getTextLang());
    $('#chapterDropdown').addClass(cssClass);
    $('#chapterDropdown').html(htmlCode);
    
    var $select = $('#chapterDropdown select').selectmenu();

    $select.on("selectmenuchange",function() {
      UI.showChapter(Number($select.val()));
    });
    
    if( CONFIG.getUILang() == 'ar') {
     $('#btnBack').button({icon:'ui-icon ui-icon-caret-1-e'});
     $('#btnNext').button({icon:'ui-icon ui-icon-caret-1-w'});
    } else {
     $('#btnBack').button({icon:'ui-icon ui-icon-caret-1-w'});
     $('#btnNext').button({icon:'ui-icon ui-icon-caret-1-e'});
    }
  },
  
  init:function() {
    this.initChaptersDropdown();
    this.openTab('homeTab');
  }
  
}

DATA = {
  verses:[],
  verses2:[],
  verses3:[],
  chaptersNames:[],
  chaptersNames2:[],
  chaptersNames3:[],
  chaptersSizes:[],
  chaptersSizes2:[],
  chaptersSizes3:[],
  
  loadVerses:function(settings) {
    $.ajax({url:CONFIG.getTextUrl(), async: false, success:$.proxy(this.parseVerses1,this)});
    
    if(CONFIG.getTextLang2()) {
      $.ajax({url:CONFIG.getTextUrl2(), async: false, success:$.proxy(this.parseVerses2,this)});
    }

    if(CONFIG.getTextLang3()) {
      $.ajax({url:CONFIG.getTextUrl3(), async: false, success:$.proxy(this.parseVerses3,this)});
    }
    
  },
  
  parseVerses1:function(text) {
    this.parseVerses(text,1);
  },
  
  parseVerses2:function(text) {
    this.parseVerses(text,2);
  },
  
  parseVerses3:function(text) {
    this.parseVerses(text,3);
  },

  parseVerses:function(text, langNum) {
    var data = [],
        lines=text.split('\n'),
        count=lines.length,
        record,
        verseNr=0,
        chapterNr=0,
        verse='',
        sortPosition='',
        currLine;
    
    for (var i = 0; i < count; i++) {
        currLine = lines[i];
        currLine = currLine.replace(/ །/,"&nbsp།"); // add non-breaking space before Tibetan shad
        currLine = currLine.replace(/་/g,"་&#x200b;"); // add zero-width space after Tibetan tseg to allow line breaking
        currLine = currLine.replace(/•/g,"&shy;"); // replace • with a soft hyphen to allow line breaking (for Sanskrit)
        
        if(currLine.indexOf('***')>=0) {
            chapterNr++;
            
            var chapterName = currLine.replace(/ *[*]+ ?/g,'');
            if(langNum===1) {
              this.chaptersNames[chapterNr] = chapterName;
            } else if(langNum===2) {
              this.chaptersNames2[chapterNr] = chapterName;
            }  else if(langNum===3) {
              this.chaptersNames3[chapterNr] = chapterName;
            }
            
            if(verse!=='') {
              data.push({id:chapterNr+'_'+verseNr, totalNr:i-1, chapter:chapterNr, nr:verseNr, verseText: verse, getId:function(){return id}});
            }

            verseNr=1;
            verse='';
            
        } else if(currLine === '') {
            if(verse!=='') {
              data.push({id:chapterNr+'_'+verseNr, totalNr:i-1, chapter:chapterNr, nr:verseNr, verseText: verse, getId:function(){return id}});
            
              verseNr++;
              verse='';
            }
        } else {
            verse += '<p>'+ currLine+'</p>';
            //verse += currLine+'<br>';
        }
        
        if(langNum===1) {        
          this.chaptersSizes[chapterNr] = verseNr - 1;
        } else if(langNum===2)  {
          this.chaptersSizes2[chapterNr] = verseNr - 1;
        } else if(langNum===3)  {
          this.chaptersSizes3[chapterNr] = verseNr - 1;
        }
    }
    
    if(langNum===1) {        
      this.verses = data;
    } else if(langNum===2) {        
      this.verses2 = data;
    } else if(langNum===3) {        
      this.verses3 = data;
    }    
  },
  
   /**
    * helper function - calculate a random integer value based on a random seed
    * @param seed the seed to initialize the random number generation
    * @param maxValue the highest value that may be returned (random numbers will be between 0 and this value, inclusive)
    * @return a random integer value
    */
  getRandomIntWithSeed: function(seed,maxValue) {
    var randomNumber = Number("0." + (Math.sin(seed).toString().substring(7)));
      return parseInt((maxValue+1)*randomNumber,10);
  },
  
  getVerseOfTheDay: function(langNum) {
    var now=new Date();
    while(true) {
      var verseInfo = this.doGetVerseOfTheDay(langNum, now);
      if(verseInfo == null) {
        return null;
      } else if(this.isDummyVerse(verseInfo.verseText)) {
        // This verse does not exist in the  given language. Jump back one year to see if we have a reasonable verse there.
        now.setFullYear(now.getFullYear()-1);
      } else {
        // We found a verse that exists. Return it.
        return verseInfo; 
      }
    }
  },

  doGetVerseOfTheDay: function(langNum, day) {
    if(this.verses2.length === 0 && langNum === 2 ) {
      return null; // don't return anything for the second language if it was not loaded
    }
    if(this.verses3.length === 0 && langNum === 3 ) {
      return null; // don't return anything for the third language if it was not loaded
    }
    var totalVerseCount = this.verses.length;
    
    //calculate a seed for the random number generator that will be stable for each day;
    //  then use it to get the random verse for today
    var now=day||new Date();
    var randSeedForTheDay = now.getFullYear()*400+now.getMonth()*31+now.getDate();
    var verseOfTheDayNr = this.getRandomIntWithSeed(randSeedForTheDay, totalVerseCount - 1);
    
    if(langNum===1)
      return this.verses[verseOfTheDayNr];
    else if(langNum===2)
      return this.verses2[verseOfTheDayNr];
    else if(langNum===3)
      return this.verses3[verseOfTheDayNr];
  },
  
  getVerseText:function(verseInfo) {
    if(verseInfo) {
      var verseText = verseInfo.verseText;
      verseText = verseText.replace(/^<p>\([0-9]+\) */,"<p>"); // remove verse number at the beginning of the first line
      verseText = verseText.replace(/^<p>\([١٢٣٤٥٦٧٨٩٠]+\) */,"<p>"); // remove Arabic verse number at the beginning of the first line
      verseText = verseText.replace(/^<p>[༡༢༣༤༥༦༧༨༩༠]+༽ */,"<p>།"); // remove Tibetan verse number at the beginning of the first line
      verseText = verseText.replace(/^<p>\([१२३४५६७८९०]+\) */,"<p>"); // remove Devanagari verse number at the beginning of the first line
      return verseText;
    } else {
      return null;
    }
  },
  
  isDummyVerse:function(verseText) {
    if((verseText.indexOf('[[') > 0) || (verseText.length < 15))
      return true;
    else
      return false;
  }
}


/*** Initialization Stuff ***/

/* initialize the UI */
function run() { 
  DATA.loadVerses();
  UI.localizeText();
  UI.init();

  var uiLangCssClass = 'uilang-' + CONFIG.getCssClassForLang(CONFIG.getUILang());
  $('body').addClass(uiLangCssClass).addClass(CONFIG.getColorTheme());
    

  var fontSize = CONFIG.getFontSize() / 100;
  // if size < 100% then only make the font in the content area Smaller 
  // Likewise, if the screen is small, don't allow zooming the header and footer too much and instead only zoom the content area 
  if(fontSize < 1 || (fontSize > 1.5 && window.innerWidth < 800) || (fontSize > 1.3 && window.innerWidth < 500) || (fontSize > 1.1 && window.innerWidth < 400)  || (window.innerWidth < 300)) 
    // the header and footer would become too small or too big: only zoom the content area
    $('.tabcontent').css('font-size', fontSize + 'em');
  else 
    // we are enlarging and there seems to be enough space -> also enlarge the header and footer 
    $('body').css('font-size', fontSize + 'em');
    
  if(!window.localStorage) {
    // if the browser doesn't support local storage we can't store settings so we have to hide the settings tab.
    $('#settingsTabBtn').hide();
  }
    
  if(navigator.userAgent.indexOf('Android 4')) {
    // add a class to the body on Android 4 to allow CSS workarounds
    $("body").addClass("android4");
  }
}

/* Do cordova-specific initializations */
function cordovaReady() {
  // Cordova is ready now.
  // do the UI initialization if it has not been done yet already:
  if(!CONFIG.isInitialized()) {
    // the initialization of the UI has not happened yet. Trigger it now and do a config migration if needed
    CONFIG.loadSettings(function() {    
      $(run);
    });
  }
  
  // register for pause / resume events and make sure that the Java part initializes the timer for ther notification message 
  document.addEventListener("pause", function() { UI.onPause(); });
  document.addEventListener("resume", function() { window.setTimeout(function(){UI.onResume();}), 1 });  
  CONFIG.getCordovaPlugin().setAlarm();
}

if((location.href.indexOf('https://') === 0)||(location.href.indexOf('localhost') > 0)) {
  // running inside the browser
  // We do not need Cordova. Initialize the UI as soon as jQuery is ready
  $(run);
} else {
  // running inside cordova
  if(!CONFIG.isSettingsMigrationNeeded()) {
    // We do not need to adjust an old or empty configuration.
    // This means that we do not need to immediately communicate with the Java part to show the IO
    // Therefore we can initialize the UI before Corova is ready, as soon as jQuery is available.
    // Cordova-specific stuff will run later when Cordova sends a deviceready event
    $(run);
  }
  document.addEventListener("deviceready", cordovaReady);  
}

</script>

</head>
<body>

<div class="header">
    <div class="tabtitle" id="homeTabTitle">
      <h1>{{App_Title}} - {{Verse of the Day}}</h1>
    </div>
    <div class="tabtitle" id="textTabTitle">
      <a href="javascript:void(0)" id="btnBack" onclick="UI.moveChapter(-1)"></a>
      <span id="chapterDropdown"></span>
      <a  href="javascript:void(0)" id="btnNext" onclick="UI.moveChapter(+1)"></a>
    </div>
    <div class="tabtitle" id="settingsTabTitle">
      <h1>{{Settings}}</h1>
    </div>
    <div class="tabtitle" id="infoTabTitle">
      <h1>{{About This App}}</h1>
    </div>
    
</div>

<div class="tabcontentWrap">
    <div id="homeTab" class="tabcontent">
      <div class="vcenterContainer">
        <div class="vcenter">
          <img src="content/info-logo.png" style="max-width:60vmin;" width="300" />    
        </div>
      </div>
    </div>

    <div id="textTab" class="tabcontent hiddenOnStartup">
    </div>

    <div id="settingsTab" class="tabcontent hiddenOnStartup">
      <div class="vcenterContainer settings"><div class="vcenter">
      
        <fieldset>
        <legend>{{Language of Shantideva's text}}</legend>
        <form>
        <p class="smallFormInfo">{{You can show the text in up to three different languages at the same time in order to compare different translations.}}</p>
        <table width="100%">
        <tr>
          <td><label for="textLanguage" class="label">{{Text Language}}:</label></td>
          <td><select id="textLanguage"></select></td>
        </tr>
        <tr>
          <td><label for="textLanguage2" class="label">{{Text Language 2}}:</label></td>
          <td><select id="textLanguage2"><option value=""> ---------------- </option></select></td>
        </tr>
        <tr>
          <td><label for="textLanguage3" class="label">{{Text Language 3}}:</label></td>
          <td><select id="textLanguage3"><option value=""> ---------------- </option></select></td>
        </tr>
        </table>
        </form>
        </fieldset>
        
        <fieldset class="hideForWeb">
        <legend>{{Notification Messages}}</legend>
        <p class="smallFormInfo">{{Enable the options below the see the verse of the day as a notification message.}}</p>
        <form>
        <table width="100%">
        <tr>
            <td><span class="label">{{Daily Message}}:</span></td>
            <td><label for="messageEnabled">{{Show Messages}}</label> <input type="checkbox" name="messageEnabled" id="messageEnabled"></td>
        </tr>
        <tr>
            <td><label for="messageHour" class="label">{{Time}}:</label></td>
            <td><select name="messageHour" id="messageHour">
              <option value="1">{{1:00}}</option>
              <option value="2">{{2:00}}</option>
              <option value="3">{{3:00}}</option>
              <option value="4">{{4:00}}</option>
              <option value="5">{{5:00}}</option>
              <option value="6">{{6:00}}</option>
              <option value="7">{{7:00}}</option>
              <option value="8">{{8:00}}</option>
              <option value="9">{{9:00}}</option>
              <option value="10">{{10:00}}</option>
              <option value="11">{{11:00}}</option>
              <option value="12">{{12:00}}</option>
              <option value="13">{{13:00}}</option>
              <option value="14">{{14:00}}</option>
              <option value="15">{{15:00}}</option>
              <option value="16">{{16:00}}</option>
              <option value="17">{{17:00}}</option>
              <option value="18">{{18:00}}</option>
              <option value="19">{{19:00}}</option>
              <option value="20">{{20:00}}</option>
              <option value="21">{{21:00}}</option>
              <option value="22">{{22:00}}</option>
              <option value="23">{{23:00}}</option>
              <option value="0">{{24:00}}</option>
            </select></td>
        </tr>
        </table>
      </form>
      </fieldset>
        
      <fieldset>
      <form>      
        <legend>{{Display Settings}}</legend>
        <table width="100%">
        <tr>
          <td><label for="uiLanguage" class="label">{{App Language}}:</label></td>
          <td><select id="uiLanguage"></select></td>
        </tr>
        <tr>
          <td><label for="fontSize" class="label">{{Font Size}}:</label></td>
          <td><select id="fontSize">
            <option value="50">{{50%}}</option>
            <option value="60">{{60%}}</option>
            <option value="70">{{70%}}</option>
            <option value="80">{{80%}}</option>
            <option value="90">{{90%}}</option>
            <option value="100">{{100%}}</option>
            <option value="110">{{110%}}</option>
            <option value="120">{{120%}}</option>
            <option value="130">{{130%}}</option>
            <option value="140">{{140%}}</option>
            <option value="150">{{150%}}</option>
            <option value="160">{{160%}}</option>
            <option value="170">{{170%}}</option>
            <option value="180">{{180%}}</option>
            <option value="200">{{200%}}</option>
          </select></td>
        </tr>
        <tr>
          <td><label for="colorTheme" class="label">{{Text color}}:</label></td>
          <td><select id="colorTheme">
            <option value="light">{{Black text on white background}}</option>
            <option value="dark">{{White text on black background}}</option>
          </select></td>
        </tr>
        </table>
      </form>        
      </fieldset>        
      <br />
      <div class="center buttons">
        <button id="cancelBtn">{{Cancel}}</button><button id="saveBtn">{{Save}}</button>
      </div>
      </div></div>
      
    </div>
    <div id="infoTab" class="tabcontent hiddenOnStartup">
      {{About_Text}}
    </div>
</div>

<div id="footer" class="footer">
 <ul class="tab hiddenOnStartup">
  <li class="active"><a href="javascript:void(0)" class="tablinks" onclick="UI.openTab('homeTab')" id="homeTabLink">{{Verse of the Day}}</a>
  </li><li><a href="javascript:void(0)" class="tablinks" onclick="UI.openTab('textTab')" id="textTabLink">{{Full Text}}</a>
  </li><li><a href="javascript:void(0)" class="tablinks" onclick="UI.openTab('settingsTab')" id="settingsTabLink">{{Settings}}</a>
  </li><li id="settingsTabBtn"><a href="javascript:void(0)" class="tablinks" onclick="UI.openTab('infoTab')" id="infoTabLink">{{About}}</a></li>
</ul>
</div>


 <script src="cordova.js" charset="UTF-8"></script>
 <!--<script type="application/javascript" src="js/index.js" charset="UTF-8"></script>-->
</body>
</html>
